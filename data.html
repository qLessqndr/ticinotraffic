<!DOCTYPE html>
<html lang="it">
<head>
	
	<script src="https://d3js.org/d3.v7.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/nouislider@15.5.0/dist/nouislider.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/nouislider@15.5.0/dist/nouislider.min.js"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tiTraffic</title>
    <style>
        html,body {
          overflow-x: hidden;
            margin: 0;
            padding: 0;
            font-family: Helvetica;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-image: url("https://raw.githubusercontent.com/qLessqndr/road_traffic_ticino/refs/heads/main/background.jpg");
            background-repeat: no-repeat;
            background-size: cover;
            min-height: 100vh;
            width: 100%;
            color: white;
            background-attachment: fixed;
        }

		svg {
      margin-bottom: 20px;
    }

    #year-slider {
      width: 800px;
      margin-bottom: 20px;
    }

    .nouislider {
      background: #333;
      border-radius: 10px;
    }

    .nouislider .noUi-handle {
      background: #4CAF50;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      top: -7px;
    }

    .nouislider .noUi-connect {
      background: #f1f1f1;
    }

    .map-button {      
      width: 50px;
      height: 50px;
      background-color: transparent;
      border: 2px solid white;
      border-radius: 5px;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 16px;
      color: white;
    }

    #play-button {
      width: 50px;
      height: 50px;
      background-color: transparent;
      border: 2px solid white;
      border-radius: 5px;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 25px;
      color: white;
    }

    #play-button.play {
      font-size: 30px;
    }

    #play-button.pause::before {
      content: "▶️";
    }

    #play-button.play::before {
      content: "⏸️";
    }

    .bar:hover {
      opacity: 0.8;
    }

    .axis path, .axis line {
      shape-rendering: crispEdges;
      stroke: white;
    }

    .axis text {
      fill: white;
    }

    .bar-text {
      font-size: 14px;
      fill: white;
      font-family: Arial;
      font-weight: 500;
    }

    .active-pip {
        font-weight: bold;
        color: rgb(255, 255, 255);
    }

    .leaflet-control-attribution {
    font-size: 10px;
    background-color: rgba(255, 255, 255, 0.1);
    padding: 5px;
    border-radius: 15px;
}

        
		.sidebar {
			width: 15%;
			padding: 20px;
			background-color: #ffffff00;
			box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
			backdrop-filter: blur(25px);
			display: flex;
			flex-direction: column;
			justify-content: space-between;
		}

        
		.title-box {
			background: rgba(0, 0, 0, 0);
			padding: 10px;
			border-radius: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			width: 99%;
			z-index: 1;
			grid-column: span 2;
		}
		.title {
			font-size: clamp(1rem, 2vw + 1rem, 3rem);
			text-align: left;
			margin: 0;
			padding: 0;
			font-weight: 700;
			color: rgb(255, 255, 255);
			text-shadow: 
			2px 2px 4px rgba(0, 0, 0, 0.5),
			0 0 25px rgba(255, 255, 255, 0.5);
		}

        .video-container {
            position: relative;
            width: 80vw;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: auto;
			margin-top: 50px;
            border-radius: 15px;
        }

        .content {
            width: 90%;
            max-width: 1200px;
            padding: 20px;
            text-align: center;
        }

        .content h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .content p {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .content img {
            max-width: 100%;
            height: auto;
        }

        .title-box {
			background: rgba(255, 255, 255, 0);
			padding: 10px;
			border-radius: 10px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			width: 99%;
			z-index: 1;
			grid-column: span 2;
		}

        .top-bar {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 60px;
			background-color: rgba(0, 0, 0, 0.8);
			color: white;
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0 20px;
			z-index: 1000;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}

        .top-bar h1 {
			font-size: 1.5rem;
			margin: 0;
		}
		.top-bar nav ul {
            margin-right: 50px;
			list-style: none;
			display: flex;
			gap: 20px;
		}
		.top-bar nav ul li a {
			color: white;
			text-decoration: none;
			font-size: 1rem;
			transition: color 0.3s;
            font-family: Helvetica;
		}
		.top-bar nav ul li a:hover {
			color: #737373;
		}

        #title-style {
			font-size: 30px;
			display: flex;
			justify-content: center;
			align-items: center;
			border-radius: 10px;
			padding: 5px;
            font-family: Helvetica;
		}

    .point {
      fill: white;
      stroke: #ff9900;
      stroke-width: 2;
    }

    .tooltip {
      position: absolute;
      background-color: white;
      color: black;
      padding: 5px;
      border-radius: 3px;
      font-size: 15px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      visibility: hidden;
    }


		.title-container {
			position: absolute;
			display: flex;
			display: flex;
			margin-top: 10%;
			justify-content: left; 
			width: 95%;
		}

		.title-subcontainer {
			position: relative;
			display: flex;
			flex-direction:column;
			margin-top: 0;
		}

		.title-left {
			font-family: "HeptaSlab";
			z-index: 100;
			color: red;
			font-size: 100px;
			font-weight: 100;
			max-height: 50px;
		}

		#subtitle {
			position: relative;
			z-index: 5;
			color: white;
			font-size: 80px;
			
			font-weight: 100;
		}

		.title-subsubcontainer {	
			position: relative;
			display: block;
			height: 100%;
			overflow: hidden;
			margin-top: 50px;
		}

		.pulsate {
			position: relative;
			animation: none;
			animation-iteration-count: infinite;
			-webkit-animation: "pulsate" 2s ease-in-out;
			-webkit-animation-iteration-count: infinite;
			
			font-family: "HeptaSlab";
			z-index: 100;
			color: rgb(182, 63, 63);
			font-weight: 250;
			font-size: 100px;
			opacity: 1;
		}

		#subtitle2 {
			font-size: 30px; position: relative; margin-top: 25px; word-wrap: break-word; max-width: 50%;
			color: white;
			font-weight: 150;
		}

		.descriptions {
      margin-top: 3%;
			margin: 0;
			position: relative;
			width: 100%;
			background-color: #00000000;
			height: 300px;
			opacity: 1;

			text-align: center;
			font-family: "HeptaSlab";
			font-size: 80px;
			font-weight: 200;
			color: #fff;
			transition: opacity 0.3s ease-in-out;
			font-size: 50px;
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
		}

		.descriptions-title {
			position: relative;
			font-family: "HeptaSlab";
			font-weight: 200;
      margin-top: 2%;
		}
		
		.descriptions-text {
			position: relative;
			font-family: "HeptaSlab";
			font-weight: 200;
      margin-top: 2%;
			font-size: 20px;
		}

    #map-container-2 {
      width: 60%;
      height: 80vh;
      margin: auto;
      border: 2px solid #333;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.5);
      border-radius: 15px;
    }
    #slider-container-2 {
      width: 100%;
      margin: 40px auto;
    }

		@-webkit-keyframes pulsate {
			0% {
				
				font-weight: 200;
				color: white;
			}
			25% {
				font-weight: 800;
				color: red;
			}
			50% {
				font-weight: normal;
			}
			100% {
				
				font-weight: 200;
				color: white;
			}
		}

    #main-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin-left: 10.5%;
        height: 50vh;
        transition: all 0.5s ease;
        margin-top: 11vh;
      }

      #map-container {
        transform-origin: 100% 0%;
        height: 85%;
        overflow: hidden;
        transition: width 0.5s ease-in-out;
        border-radius: 10px;
        margin-right: -7%;
        margin-top: 3%;
        width: 30%;
      }

      #chart-container {
        transform-origin: 100% 50%;
        z-index: 1000;
        width: 100%;
        height: 100%;
        margin-top: 5%;
        margin-left: -7%;
        position: relative;
        transition: margin-left 0.5s ease-in-out, width 0.5s ease-in-out, transform 0.5s ease-in-out;
      }

      #chart-container.stretch {
        transform: scaleX(0.85);
      }

      .svg-container {
        width: 70vw;
        height: 55vh;
      }

      #date-picker {
      display: none;
      margin-top: 10px;
    }

    .tooltip-container {
    z-index: 100000;
    position: relative;
    display: inline-block;
}

.tooltip-content {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    padding: 15px;
    background: #181818;
    color: #ffffff;
    border: none;
    z-index: 1000;
    box-shadow: none;
}

.tooltip-content.active {
    display: block;
}

.tooltip-content p {
    margin: 0;
    font-size: 18px;
}

.tooltip-link {
    cursor: pointer;
    color: #585858;
    text-decoration: underline;
}

.tooltip-link:hover {
    color: #ffffff;
}

#date-picker-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 4%;
}

#date-picker {
    display: block;
    font-size: 20px;
    padding: 10px 15px;
    width: auto;
    height: 4%;
    border: 2px solid #444;
    border-radius: 5px;
    background-color: #1e1e1e;
    color: #fff;
    cursor: pointer;
    transition: border-color 0.3s, background-color 0.3s, color 0.3s;
}

#date-picker:hover {
    background-color: #333;
    border-color: #666;
}

#date-picker:focus {
    border-color: #888;
    outline: none;
}

#date-picker::-webkit-calendar-picker-indicator {
    cursor: pointer;
    filter: invert(1);
}

.sep-box {
  height: 3px;
  margin-left: 15%;
  background-color: rgb(151, 32, 32);
  width: 10%;
  margin-top: 5%;
  border-radius: 5px;
  margin-top: 1%;
  margin-bottom: 0%;
}


.banner {
  background-color: rgb(0, 0, 0);
  width: 110%;
  margin-top: -1%;
  height: auto + 10%;
  transform-origin: top;
  padding-left: 25vw;
  align-items: center;
  display: block;
  position: relative;
  box-shadow: 0 -10px 20px rgba(0, 0, 0, 0.6), 0 10px 20px rgba(0, 0, 0, 0.6);
}

.counter {
  min-width: 200px; 
  max-width: auto; 
  text-align: left;
  font-size: 4rem; 
  font-weight: bold; 
  overflow: show;
  white-space: nowrap; 
  line-height: 1.2;
}

.counter.active {
  opacity: 1;
  transition: opacity 1s;
}


.buttons {
  
  display: inline-block;
                    outline: none;
                    cursor: pointer;
                    font-size: 14px;
                    line-height: 1;
                    border-radius: 500px;
                    transition-property: background-color,border-color,color,box-shadow,filter;
                    transition-duration: .3s;
                    border: 1px solid transparent;
                    letter-spacing: 2px;
                    min-width: 160px;
                    text-transform: uppercase;
                    white-space: normal;
                    font-weight: 700;
                    text-align: center;
                    padding: 16px 14px 18px;
                    color: #616467;
                    box-shadow: inset 0 0 0 2px #616467;
                    background-color: transparent;
                    height: 48px;
                    :hover{
                        color: #fff;
                        background-color: #616467;
                    }
                
}

.back-buttons {
  
  display: inline-block;
                    outline: none;
                    cursor: pointer;
                    font-size: 14px;
                    line-height: 1;
                    border-radius: 500px;
                    transition-property: background-color,border-color,color,box-shadow,filter;
                    transition-duration: .3s;
                    border: 1px solid transparent;
                    letter-spacing: 2px;
                    min-width: 160px;
                    text-transform: uppercase;
                    white-space: normal;
                    font-weight: 700;
                    text-align: center;
                    padding: 16px 14px 18px;
                    color: #616467;
                    box-shadow: inset 0 0 0 2px #616467;
                    background-color: transparent;
                    height: 48px;
                    :hover{
                        color: #fff;
                        background-color: #616467;
                    }
                
}

        @font-face {
            font-family: Helvetica;
            src: url("https://raw.githubusercontent.com/qLessqndr/road_traffic_ticino/refs/heads/main/templates/Helvetica-Bold.ttf")
        }

        @font-face {
            font-family: "HeptaSlab";
            src: url("https://raw.githubusercontent.com/qLessqndr/road_traffic_ticino/refs/heads/main/templates/HeptaSlab.ttf")
        }
		
		@media only screen and (max-width: 900px) {
			.title-left {
				font-size: 70px;
			}
			#subtitle {
				font-size: 40px;
				font-weight: 200;
			}
			#subtitle2 {
				margin-top: 6px;
				font-size: 15px;
				font-weight: 200;
			}
			.title-subsubcontainer {
				overflow: visible;
			}
			.pulsate {
				margin-top: -45px;
				font-size: 70px;
			}
			.top-bar h1 {
				font-size: 10px;
			}
			#title-style {
				font-size: 20px;
			}
		}

		@media only screen and (max-width: 600px) {
			.title-left {
				font-size: 50px;
			}
			#subtitle {
				font-size: 30px;
			}
			#subtitle2 {
				margin-top: -6px;
				font-size: 15px;
			}
			.title-subsubcontainer {
				overflow: visible;
			}
			.pulsate {
				margin-top: -50px;
				font-size: 60px;
			}
			.top-bar nav ul li a {
				font-size: 12px;
			}
			#title-style {
				font-size: 20px;
			}
		}

    </style>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="banner">
    <div class="top-background"></div>
		<div class="top-bar" style="z-index: 20000">
			<h1 id="title-style">tiTraffic</h1>
			<nav>
				<ul>
					<li><a href="#">Home</a></li>
					<li><a href="#section1">Overview</a></li>
					<li><a href="#section2">Ticino Timeline</a></li>
					<li><a href="#section3">Yearly Pattern</a></li>
					<li><a href="#section4">Worse Places</a></li>
					<li><a href="#section5">Real Time</a></li>
				</ul>
			</nav>
		</div>
	<div class="title-container">
		<div class="title-subcontainer">
			<div class="title-left" id="subtitle">Ticino's</div>
			<div class="title-subsubcontainer">
				<div class="pulsate">Traffic</div>
			</div>
			<div class="title-left" id="subtitle2">
				How much has traffic in Ticino
				changed in the last 60 years?
			</div>
		</div>
	</div>

    <div class="video-container">
        <video id="customVideo" autoplay muted loop style="margin-left: 50%">
            <source src="https://raw.githubusercontent.com/qLessqndr/road_traffic_ticino/refs/heads/main/templates/start_video.mp4" type="video/mp4">
        </video>
    </div>
  </div>
    
<div class="banner" style="height: 100%; grid-template-columns: 1; display: grid; padding: 0%; padding-bottom: 10%" >
    <div class="descriptions" style="margin-top: 150px">
      <div class="descriptions-title" style="text-align: left; margin-left: 15%; "><b>About traffic</b></div>	
      <div class="sep-box"></div>
      <div class="descriptions-text" style="text-align: left; font-size: 1.7rem; font-weight: 700; margin-left: 15%; margin-right: 15%">Why is it important to analyze traffic and what are the consequences?</div>		

      <div class="descriptions-text" style="text-align: left; font-size: 1.3rem; font-weight: 300;  margin-left: 15%; margin-right: 15%">As you know, traffic congestion is a major issue affecting cities and urban areas. With population growth and urban expansion, the number of vehicles on the roads has significantly increased in recent decades. This problem leads to serious consequences, including traffic jams, air pollution, noise, longer travel times, an increase in road accidents, and a negative impact on the quality of life.</div>		
    </div>

  </div>


<div style="height: 35vh">

  <div style="height: 100%; grid-auto-flow: column; display: grid; width: 100%; gap: 18%; align-items: center; justify-content: center;">
  <div style="width:auto ;margin: 2% ;justify-content: center;">
    <div class="counter" data-target="408254" data-text=" v"></div>
  <div class="description" style="text-align: center; margin-top: 10%; font-size: 1.5rem;">New vehicles</div>
  <div class="description" style="text-align: center;">Registration</div>
</div>

<div style="width:auto; margin: 2%; justify-content: center;">
  <div class="counter" data-target="16.6" data-text="+v%"></div>
  <div class="description" style="text-align: center;margin-top: 10%; font-size: 1.5rem;" >Change</div>
  <div class="description" style="text-align: center;">2022 - 2023</div>
</div>

<div style="width:auto;margin: 2%;justify-content: center;">
  <div class="counter" data-target="40.9" data-text="v%"></div>
  <div class="description" style="text-align: center;margin-top: 10%; font-size: 1.5rem;">CO2 Emissions</div>
  <div class="description" style="text-align: center;">Over Total</div>
</div>

</div>
</div>

  <div class="banner" style="height: 100%; grid-template-columns: 1; display: grid; padding: 0%; padding-bottom: 10%; justify-content: center;" >
	<div class="descriptions">
		<div class="descriptions-title">Overview</div>	
		<div class="descriptions-text">In this animation we will explore the traffic in the last 60 years in Switzerland</div>		
    <div id="section1"></div>
	</div>

  
    <div class="video-container" style="width: 90%; overflow: visible">
        <video style="overflow:visible;width: 90%; margin-left: 10%; z-index: 10000" id="customVideo" controls muted loop>
            <source src="https://raw.githubusercontent.com/qLessqndr/road_traffic_ticino/refs/heads/main/video_.mp4" type="video/mp4">
        </video>
    </div>
    <div class="tooltip-container" style="margin-left: 41.1%">
      <span class="tooltip-link">Visualization Protocol</span>
      <div class="tooltip-content">
        <button class="back-buttons" style="margin-right: 2%">Back</button>
          <p>Timestamp: 1965 - 2023</p>
          <p></p>
      </div>
    </div>

    

  <div class="banner" style="height: 100%; grid-template-columns: 1; display: grid; padding: 0%; padding-bottom: 10%; align-items: center;" >
    <div class="descriptions" style="margin-top: 1%">
      <div class="descriptions-title">Graph</div>	
      <div class="descriptions-text">Graph of the animation</div>		
    </div>


<div class="tooltip" id="tooltip"></div>

<div class="svg-container" id="svg-container3">
<svg id="svg3" width="100%" height="100%" style="margin-left: 13%"></svg></div>
<div class="tooltip-container" style="margin-left: 41.1%">
  <span class="tooltip-link">Visualization Protocol</span>
  <div class="tooltip-content">
    <button class="back-buttons" style="margin-right: 2%">Back</button>
      <p>Timestamp: 1965 - 2023</p>
      <p></p>
  </div>
</div>


  </div>
	


    <div class="descriptions">
      <div class="descriptions-title">Traffic in Ticino</div>
      <div class ="descriptions-text">How has traffic changed in Ticino?</div>		
      <div id="section2"></div>
    </div>
    <div class="tooltip" id="tooltip"></div>
    
    <div class="svg-container" id="svg-container2" style="margin-left: 12%">
      <svg id="svg2" width="100%" height="100%"></svg>
    </div>
    <div class="tooltip-container"style="margin-left: 46.1%">
      <span class="tooltip-link">Visualization Protocol</span>
      <div class="tooltip-content">
        <button class="back-buttons" style="margin-right: 2%">Back</button>
          <p>Protocol</p>
          <p></p>
      </div>
    </div>


    
  <div class="descriptions">    
    <div class="descriptions-title">Monthly pattern</div>
    <div class ="descriptions-text">2023</div>	
    <div id="section3"></div>	
  </div>
  <div class="svg-container" id="svg-container4"style="margin-left: 13.5%">
  <svg id="svg4" width="100%" height="100%"></svg>
  </div>

  <div style="display: block; align-items: center; width: 75%; margin-top: 1%; margin-left: 43.5%; justify-content: space-between;">
    
    <button class="buttons" id="toggleButton" style="margin-right: 2%"></button>
  <div class="tooltip-container">
    <span class="tooltip-link">Visualization Protocol</span>
    <div class="tooltip-content">
        
    <button class="back-buttons" style="margin-right: 2%">Back</button>
        <p>Protocol</p>
        <p></p>
    </div>
  </div>
</div>

    <div class="descriptions" style="margin-bottom: -150px">
        <div class="descriptions-title">Worse places in Ticino</div>
        <div class ="descriptions-text">Top 6 most busy roads</div>		
        <div id="section4"></div>
    </div>

    
    <div id="main-container">
      <div id="map-container"></div>
      <div id="chart-container">
        <svg id="svg1" width="100%" height="100%"></svg>
        
      </div>
    </div>
    <div style="display: flex; align-items: center; width: 75%; margin-top: 3%; margin-left: 11%;">
          
      <button class="map-button" id="toggle-map-button" style="z-index: 10000; margin-right: 10px;">
            <img src="https://raw.githubusercontent.com/qLessqndr/road_traffic_ticino/refs/heads/main/templates/map-icon.png" type="image/png"  style="width: 40px; height: 40px;">
          </button>
      <button id="play-button" class="pause" style="z-index: 10000; margin-right: 50px;"></button>
      
      <div id="year-slider" style="flex-grow: 1;"></div>
    </div>
    <span id="year-display" style="color: transparent">2003</span>

    <div class="tooltip-container"style="margin-left: 46.1%; margin-top: 1%">
      <span class="tooltip-link">Visualization Protocol</span>
      <div class="tooltip-content">
    <button class="back-buttons" style="margin-right: 2%">Back</button>
          <p>Protocol</p>
          <p></p>
      </div>
  </div>

  <div class="content">
    <h1></h1>
</div>


</div>


<div class="banner" style="height: 100%; grid-template-columns: 1; display: grid; padding: 0%; padding-bottom: 10%; align-items: center;" >



  
  <div class="descriptions">
    <div class="descriptions-title">Real Time Traffic Speed</div>
    <div class ="descriptions-text">This map shows the average traffic speed for all main roads in Ticino</div>		
    <div id="section5"></div>
  </div>
  <div id="map-container-2"></div>
  
  <div style="display: flex; align-items: center; width: 60%; margin-top: 2%; margin-left: 20%;">    
    <div id="date-picker-container">
      <input type="date" id="date-picker" />
  </div>
  

  <div id="slider-container-2" style="margin-left: 4%"></div></div>

  <div class="tooltip-container" style="margin-left: 45.5%; margin-top: 1%;">
    <span class="tooltip-link">Visualization Protocol</span>
    <div class="tooltip-content">
        <p>Protocol</p>
        <p></p>
    </div>
</div>
</body>
</html>

<script>


const meanTopButton = document.getElementById('toggleButton');
let meanTop = false;
  meanTopButton.textContent = 'Top 6 (click)';
meanTopButton.addEventListener('click', function() {
  if (meanTop === true) {
  meanTopButton.textContent = 'Top 6 (click)';
  }
  else {
    
  meanTopButton.textContent = 'Average (click)';
  }
  meanTop = !meanTop;
});


document.addEventListener("DOMContentLoaded", () => {
    const tooltipLinks = document.querySelectorAll(".tooltip-link");
    const tooltips = document.querySelectorAll(".tooltip-content");

    tooltipLinks.forEach((link, index) => {
        link.addEventListener("click", (e) => {
            e.preventDefault();
            tooltips.forEach((tooltip) => tooltip.classList.remove("active"));
            tooltips[index].classList.toggle("active");
        });
    });

    const backButtons = document.querySelectorAll('.back-buttons');
    backButtons.forEach(but => {
        but.addEventListener('click', () => {
            tooltips.forEach((tooltip) => tooltip.classList.remove("active"));
        });
    });
});


const mapContainer = document.getElementById('map-container');
      const chartContainer = document.getElementById('chart-container');
      const mainContainer = document.getElementById('main-container');
      let mapVisible = false;
      let map;
      const svg = d3.select("#svg1");
      const height = +chartContainer.clientHeight;
      const width = chartContainer.clientWidth;
      const margin = {
        top: 20,
        right: 100,
        bottom: 80,
        left: 200
      };
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;
      const xScale = d3.scaleLinear().range([0, innerWidth]);
      const yScale = d3.scaleBand().range([0, innerHeight]).padding(0.1);
      const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
      const xAxisGroup = g.append("g").attr("transform", `translate(0,${innerHeight})`);
      const yAxisGroup = g.append("g");
      const svgObject = document.getElementById('svg')
      g.append("rect").attr("class", "x-axis-background").attr("x", 0).attr("y", innerHeight).attr("width", Math.max(0, innerWidth + 30)).attr("height", height - innerHeight).attr("fill", "black").lower();
      const yearText = g.append("text").attr("id", "current-year").attr("x", innerWidth - 10).attr("y", innerHeight - 70).style("fill", "white").style("font-size", "24px").style("text-anchor", "end").style("font-family", "Arial").style("font-weight", "500").style("font-size", "100").text("2003");
      const totalText = g.append("text").attr("id", "total-value").attr("x", innerWidth - 15).attr("y", innerHeight - 30).style("fill", "white").style("font-size", "18px").style("text-anchor", "end").style("font-family", "Arial").style("font-weight", "200").style("font-size", "20").text("Total: 0");
      let data = [];
      let currentYear = 2003;
      let playing = false;
      let interval;
      const colorScale = d3.scaleLinear().domain([0, 1]).range(["#e30f00", "#ff9900"]);
      d3.csv("https://raw.githubusercontent.com/qLessqndr/road_traffic_ticino/refs/heads/main/final_dataset.csv").then((rawData) => {
        data = rawData.map((row) => {
          const station = row["Station"];
          const canton = row["Canton"];
          const yearMeans = Object.entries(row).filter(([key, value]) => key.includes("Year mean")).map(([key, value]) => ({
            year: +key.split("_")[1],
            value: +value || 0,
            nextValue: NaN,
          }));
          return {
            station,
            canton,
            yearMeans
          };
        });
        console.log(data);
        const tiData = data.filter((d) => d.canton === "TI");
        const barsGroup = g.append("g").attr("class", "bars-group");
        const stationNames = {
          "BRISSAGO S": "Brissago Sud",
          "STABIO": "Stabio",
          "GRANCIA (AS)": "Grancia",
          "CHIASSO-BROGEDA (AS)": "Chiasso-Brogeda",
          "MONTE CENERI (AS)": "Monte Ceneri",
          "BIASCA S (AS)": "Biasca Sud",
          "MENDRISIO S (AS)": "Mendrisio Sud",
          "MOLENO N (AB)": "Moleno Nord",
          "CAMIGNOLO (AS)": "Camignolo",
          "QUINTO (AS)": "Quinto",
          "MAGADINO": "Magadino",
          "SOLDUNO N": "Solduno Nord",
          "CIRCONVALLAZIONE DI LUGANO": "Lugano (C)",
          "MENDRISIO N  (AS)": "Mendrisio Nord",
          "QUARTINO": "Quartino",
          "CAVIANO DOGANA DIRINELLA": "Caviano Dogana",
          "OLIVONE - LUCOMAGNO": "Olivone-Lucomagno",
          "TENERO": "Tenero",
          "INTRAGNA-CENTOVALLI": "Intragna-Centovalli",
          "ASCONA GALLERIA": "Ascona Galleria",
          "LOCARNO, TUNNEL MAPPO MORETTINA": "Tunnel Mappo Morettina",
          "GALLERIA VEDEGGIO-CASSARATE": "Galleria Vedeggio-Cassarate",
          "VEZIA W": "Vezia Ovest",
          "CIRCONVAL. BELLINZONA (CAS)": "Bellinzona (C)"
        };
        const stationCoordinates = {
  "BRISSAGO S": {
    lat: 46.1517,
    lon: 8.7675
  },
  "STABIO": {
    lat: 45.8673,
    lon: 8.9497
  },
  "GRANCIA (AS)": {
    lat: 46.0167,
    lon: 8.9242
  },
  "CHIASSO-BROGEDA (AS)": {
    lat: 45.8414,
    lon: 9.0331
  },
  "MONTE CENERI (AS)": {
    lat: 46.0489,
    lon: 8.9513
  },
  "BIASCA S (AS)": {
    lat: 46.3356,
    lon: 8.9808
  },
  "MENDRISIO S (AS)": {
    lat: 45.8694,
    lon: 8.9836
  },
  "MOLENO N (AB)": {
    lat: 46.3541,
    lon: 8.8439
  },
  "CAMIGNOLO (AS)": {
    lat: 46.0911,
    lon: 8.9489
  },
  "QUINTO (AS)": {
    lat: 46.3133,
    lon: 8.9055
  },
  "MAGADINO": {
    lat: 46.1444,
    lon: 8.8872
  },
  "SOLDUNO N": {
    lat: 46.1653,
    lon: 8.8156
  },
  "CIRCONVALLAZIONE DI LUGANO": {
    lat: 46.0095,
    lon: 8.9500
  },
  "MENDRISIO N  (AS)": {
    lat: 45.8761,
    lon: 8.9871
  },
  "QUARTINO": {
    lat: 46.0847,
    lon: 8.8999
  },
  "CAVIANO DOGANA DIRINELLA": {
    lat: 46.1050,
    lon: 8.9493
  },
  "OLIVONE - LUCOMAGNO": {
    lat: 46.4222,
    lon: 8.6144
  },
  "TENERO": {
    lat: 46.1511,
    lon: 8.8650
  },
  "INTRAGNA-CENTOVALLI": {
    lat: 46.1692,
    lon: 8.7306
  },
  "ASCONA GALLERIA": {
    lat: 46.1606,
    lon: 8.7622
  },
  "LOCARNO, TUNNEL MAPPO MORETTINA": {
    lat: 46.0342,
    lon: 8.7417
  },
  "GALLERIA VEDEGGIO-CASSARATE": {
    lat: 46.0221,
    lon: 8.9512
  },
  "VEZIA W": {
    lat: 46.0162,
    lon: 8.9349
  },
  "CIRCONVAL. BELLINZONA (CAS)": {
    lat: 46.1932,
    lon: 9.0246
  }
};

let hoveredBarStation = null;

        function update(year) {
          const duration = 150;
          const interpolVal = Math.ceil(year) - year;
          const yearData = tiData.map((d) => {
            const prevValue = d.yearMeans.find((y) => y.year === Math.floor(year))?.value || 0;
            const nextValue = d.yearMeans.find((y) => y.year === Math.floor(year) + 1)?.value || 0;
            const value = nextValue * interpolVal + prevValue * (1 - interpolVal);
            return {
              station: d.station,
              prevValue,
              nextValue,
              value
            };
          });
          yearData.sort((a, b) => b.value - a.value);
          const topStations = yearData.slice(0, 6);
          xScale.domain([0, d3.max(topStations, (d) => d.value)]);
          yScale.domain(topStations.map((d) => d.station));
          xAxisGroup.transition().duration(duration).call(d3.axisBottom(xScale)).selectAll("text").style("font-family", "Arial").style("font-weight", "bold").style("fill", "white").style("font-size", "15");
          const yAxis = d3.axisLeft(yScale).tickFormat(d => stationNames[d] || d);
          yAxisGroup.transition().duration(duration).call(yAxis).selectAll("text").style("font-family", "Arial").style("font-size", "16px").style("font-weight", "bold").style("fill", "white");
          const totalValue = d3.sum(yearData, (d) => d.value);
          yearText.transition().duration(duration).text(Math.round(year));
          totalText.transition().duration(duration).text(`Total: ${totalValue.toFixed(0)}`);
          const bars = barsGroup.selectAll(".bar").data(topStations, (d) => d.station);
          const texts = barsGroup.selectAll(".bar-text").data(topStations, (d) => d.station);
          bars.exit().transition().duration(duration).attr("y", innerHeight + 50).remove();
          bars.transition().duration(duration).attr("x", 0).attr("y", (d) => yScale(d.station)).attr("width", (d) => Math.max(0, xScale(d.value))).attr("height", yScale.bandwidth()).attr("fill", (d, i) => colorScale(i / 5)).attr("rx", 5);
          
          bars.enter()
  .append("rect")
  .attr("class", "bar")
  .attr("x", 0)
  .attr("y", innerHeight + 50)
  .attr("width", (d) => Math.max(0, xScale(d.value)))
  .attr("height", yScale.bandwidth())
  .attr("fill", (d, i) => colorScale(i / 5))
  .on("mouseover", function(event, d) {
    const coordinates = stationCoordinates[d.station];
    hoveredBarStation = d.station;
    if (coordinates) {
      map.eachLayer(function(layer) {
        if (layer instanceof L.CircleMarker) {
          const latLng = layer.getLatLng();
          if (latLng.lat === coordinates.lat && latLng.lng === coordinates.lon) {
            layer.setStyle({
              fillColor: "#73ff00",
              color: "#73ff00",
              fillOpacity: 1,
              radius: layer.options.radius * 1.5
            });
          }
        }
      });
    }
  })
  .on("mouseout", function(event, d) {
    hoveredBarStation = null;
    const coordinates = stationCoordinates[d.station];

    if (coordinates) {
      map.eachLayer(function(layer) {
        if (layer instanceof L.CircleMarker) {
          const latLng = layer.getLatLng();
          if (latLng.lat === coordinates.lat && latLng.lng === coordinates.lon) {
            const index = yearData.findIndex((station) => station.station === d.station);
            const originalColor = index < 6 ? colorScale(index / 5) : "#9fa8b5";
            layer.setStyle({
              fillColor: originalColor,
              color: originalColor,
              fillOpacity: 0.7,
              radius: Math.max(5, d.value / 7500)
            });
          }
        }
      });
    }
  })
  .transition()
  .duration(duration)
  .attr("rx", 5)
  .attr("y", (d) => yScale(d.station));
     
          barsGroup.lower();
          texts.exit().transition().duration(duration).attr("y", innerHeight + 50).remove();
          texts.transition().duration(duration).attr("x", (d) => xScale(d.value) - 70).style("font-size", "20").attr("y", (d) => yScale(d.station) + yScale.bandwidth() / 2 + 5).text((d) => Math.round(d.value));
          texts.enter().append("text").style("font-size", "20").attr("class", "bar-text").attr("x", (d) => xScale(Math.round(d.value) - 70)).attr("y", innerHeight + 50).text((d) => Math.round(d.value)).transition().duration(duration).attr("y", (d) => yScale(d.station) + yScale.bandwidth() / 2 + 5);
          updateMap(yearData);
        }

        function animateBars(targetYear) {
          currentYear = targetYear;
          update(currentYear);
        }

        
      function initializeMap() {
        if (map) {
          map.remove();
        }
        map = L.map(mapContainer).setView([46.1511, 8.886], 10);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors'
        }).addTo(map);
      }
      initializeMap();
      chartContainer.classList.remove('stretch');
      mapContainer.style.width = '0';
      mainContainer.classList.remove('show-map');
      chartContainer.style.marginLeft = '10%';

      function toggleMap() {
        if (mapVisible) {
          chartContainer.classList.remove('stretch');
          mapContainer.style.width = '0';
          mainContainer.classList.remove('show-map');
      chartContainer.style.marginLeft = '10%';
        } else {
          chartContainer.classList.add('stretch');
          mapContainer.style.width = '22%';
          mainContainer.classList.add('show-map');
      chartContainer.style.marginLeft = '-7%';
        }
        mapVisible = !mapVisible;
        update(currentYear);
      }

      function updateMap(yearData) {
  map.eachLayer(function(layer) {
    if (layer instanceof L.CircleMarker) {
      map.removeLayer(layer);
    }
  });

  const filteredData = yearData.filter(d => d.value > 0);

  filteredData.sort((a, b) => b.value - a.value);

  const top6Stations = filteredData.slice(0, 6);
  let i = 0;
  filteredData.forEach((d) => {
    const stationName = d.station;
    const value = d.value;
    const coordinates = stationCoordinates[stationName];

    if (coordinates) {
      const radius = Math.max(5, value / 7500);

      let color;
      if (top6Stations.some(station => station.station === stationName)) {
        
        if(hoveredBarStation !== stationName)
          color = colorScale(i/5);
        else
        color = "#73ff00";

      } else {
        color = '#9fa8b5';
      }
      i+=1;
      
      const circle = L.circleMarker([coordinates.lat, coordinates.lon], {
        radius: radius,
        color: color,
        fillColor: color,
        fillOpacity: 0.7
      }).addTo(map).bindTooltip(`${stationName}
					<br>Value: ${value.toFixed(0)}`, {
        permanent: false,
        direction: 'top'
      });

      circle.on('mouseover', function() {
        this.openTooltip();
      });
      circle.on('mouseout', function() {
        this.closeTooltip();
      });
    }
  });
}
     

      document.getElementById("toggle-map-button").addEventListener("click", toggleMap);


        const slider = document.getElementById('year-slider');
        noUiSlider.create(slider, {
          start: [2003],
          connect: true,
          range: {
            'min': 2003,
            '10%': 2005,
            '20%': 2007,
            '30%': 2009,
            '40%': 2011,
            '50%': 2013,
            '60%': 2015,
            '70%': 2017,
            '80%': 2019,
            '90%': 2021,
            'max': 2023
          },
          step: 0.0,
          pips: {
            mode: 'steps',
            density: 5,
          },
          format: {
            to: function(value) {
              return value;
            },
            from: function(value) {
              return value;
            }
          }
        });
        var activePips = [null, null];
        slider.noUiSlider.on('update', function(values, handle) {
          const year = values[handle];
          animateBars(year);
          d3.select("#year-display").text(year);
          if (activePips[handle]) {
            activePips[handle].classList.remove('active-pip');
          }
          var dataValue = Math.round(values[handle]);
          activePips[handle] = slider.querySelector('.noUi-value[data-value="' + dataValue + '"]');
          if (activePips[handle]) {
            activePips[handle].classList.add('active-pip');
          }
        });
        slider.noUiSlider.on('set', function() {
          const year = slider.noUiSlider.get();
        });
        d3.select("#play-button").on("click", function() {
          playing = !playing;
          if (playing) {
            d3.select("#play-button").classed("play", true).classed("pause", false);
            interval = setInterval(() => {
              if (currentYear >= 2023) {
                clearInterval(interval);
                d3.select("#play-button").classed("play", false).classed("pause", true);
                playing = false;
                return;
              }
              currentYear += 0.015;
              slider.noUiSlider.set(currentYear);
              d3.select("#year-display").text(currentYear);
            }, 50);
          } else {
            clearInterval(interval);
            d3.select("#play-button").classed("play", false).classed("pause", true);
          }
        });
        

      update(currentYear);
      });


    //LINE 1
    const svg2 = d3.select("#svg2");
const svg_cont1 = document.getElementById("svg-container2");
const width2 = svg_cont1.clientWidth;
const height2 = svg_cont1.clientHeight;
const margin2 = { top: 20, right: 100, bottom: 80, left: 100 };
const innerWidth2 = width2 - margin2.left - margin2.right;
const innerHeight2 = height2 - margin2.top - margin2.bottom;

const g2 = svg2.append("g").attr("transform", `translate(${margin2.left},${margin2.top})`);
const xAxisGroup2 = g2.append("g").attr("transform", `translate(0,${innerHeight2})`);
const yAxisGroup2 = g2.append("g");


g2.append("text")
  .attr("class", "x-axis-label")
  .attr("x", innerWidth2 / 2)
  .attr("y", innerHeight2 + 50)
  .attr("text-anchor", "middle")
  .style("fill", "white")
  .style("font-size", "16px")
  .style("font-family", "Helvetica")
  .text("Year");

g2.append("text")
  .attr("class", "y-axis-label")
  .attr("x", -innerHeight2 / 2)
  .attr("y", -60)
  .attr("transform", "rotate(-90)")
  .attr("text-anchor", "middle")
  .style("fill", "white")
  .style("font-size", "16px")
  .style("font-family", "Helvetica")
  .text("Daily Vehicle Count");


g2.append("rect")
  .attr("class", "x-axis-background")
  .attr("x", 0)
  .attr("y", innerHeight2)
  .attr("width", innerWidth2)
  .attr("height", height2 - innerHeight2)
  .lower();

const color2 = "#ff9900";

const xScale2 = d3.scaleLinear().range([0, innerWidth2]);
const yScale2 = d3.scaleLinear().range([innerHeight2, 0]);

const lineGenerator2 = d3.line()
  .x(d => xScale2(d.year))
  .y(d => yScale2(d.value))
  .curve(d3.curveMonotoneX);

const pointRadius2 = 4;

const tooltip2 = d3.select("#tooltip");

let data2 = [];

d3.csv("https://raw.githubusercontent.com/qLessqndr/road_traffic_ticino/refs/heads/main/final_dataset.csv").then(rawData => {
  console.log(rawData);
  data2 = rawData.filter(d => d.Canton === "TI").map(d => {
    return Object.entries(d).filter(([key]) => key.startsWith("Year mean")).map(([key, value]) => {
      const year = +key.split("_")[1];
      return { year, value: +value || 0 };
    });
  });

  const averages2 = [];
  for (let i = 1995; i <= 2023; i++) {
    const yearData2 = data2.map(d => d.find(e => e.year === i)?.value || 0);
    const meanValue = d3.mean(yearData2);
    if (!isNaN(meanValue) && meanValue != 0) {
      averages2.push({ year: i, value: meanValue });
    }
  }

  xScale2.domain(d3.extent(averages2, d => d.year));
  yScale2.domain([0, d3.max(averages2, d => d.value)]);

  const xAxis2 = d3.axisBottom(xScale2).ticks(10).tickFormat(d3.format("d"));
  xAxisGroup2.call(xAxis2).selectAll("text")
    .style("fill", "white")
    .style("font-size", "14px")
    .style("font-family", "Helvetica");

  const yAxis2 = d3.axisLeft(yScale2);
  yAxisGroup2.call(yAxis2).selectAll("text")
    .style("fill", "white")
    .style("font-size", "14px")
    .style("font-family", "Helvetica");

  const path2 = g2.append("path")
    .datum(averages2)
    .attr("class", "line")
    .attr("d", lineGenerator2)
    .attr("stroke", color2)
    .attr("opacity", 0);

  const points2 = g2.selectAll(".point")
    .data(averages2)
    .enter().append("circle")
    .attr("class", "point")
    .attr("cx", d => xScale2(d.year))
    .attr("cy", d => yScale2(d.value))
    .attr("r", 0)
    .attr("fill", color2)
    .on("mouseover", (event, d) => {
      d3.select(event.target)
        .transition()
        .duration(200)
        .attr("r", pointRadius2 * 2);

      tooltip2.style("visibility", "visible")
        .text(`Year: ${d.year}, Daily Mean: ${d.value.toFixed(0)}`)
        .style("top", `${event.pageY - 10}px`)
        .style("left", `${event.pageX + 10}px`);
    })
    .on("mouseout", (event) => {
      d3.select(event.target)
        .transition()
        .duration(200)
        .attr("r", pointRadius2);

      tooltip2.style("visibility", "hidden");
    });

  const animateLineAndPoints = () => {
    path2.transition()
      .duration(3000)
      .attr("opacity", 1);

    points2.transition()
      .delay((d, i) => i * 100)
      .duration(500)
      .attr("r", pointRadius2);
  };

  const hideLineAndPoints = () => {
    path2.transition().duration(500).attr("opacity", 0);
    points2.transition().duration(500).attr("r", 0);
  };

  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        animateLineAndPoints();
      } else {
        hideLineAndPoints();
      }
    });
  }, {
    threshold: 0.5
  });

  observer.observe(svg2.node());
});


//LINE 2

const svg3 = d3.select("#svg3");
const container2 = document.getElementById("svg-container3");
const width3 = container2.clientWidth;
const height3 = container2.clientHeight;

const margin3 = { top: 20, right: 100, bottom: 80, left: 100 };
const innerWidth3 = width3 - margin3.left - margin3.right;
const innerHeight3 = height3 - margin3.top - margin3.bottom;

const g3 = svg3.append("g").attr("transform", `translate(${margin3.left},${margin3.top})`);
const xAxisGroup3 = g3.append("g").attr("transform", `translate(0,${innerHeight3})`);
const yAxisGroup3 = g3.append("g");


g3.append("text")
  .attr("class", "x-axis-label")
  .attr("x", innerWidth2 / 2)
  .attr("y", innerHeight2 + 50)
  .attr("text-anchor", "middle")
  .style("fill", "white")
  .style("font-size", "16px")
  .style("font-family", "Helvetica")
  .text("Year");

g3.append("text")
  .attr("class", "y-axis-label")
  .attr("x", -innerHeight2 / 2)
  .attr("y", -75)
  .attr("transform", "rotate(-90)")
  .attr("text-anchor", "middle")
  .style("fill", "white")
  .style("font-size", "16px")
  .style("font-family", "Helvetica")
  .text("Daily Vehicle Count");


g3.append("rect")
  .attr("class", "x-axis-background")
  .attr("x", 0)
  .attr("y", innerHeight3)
  .attr("width", innerWidth3)
  .attr("height", height3 - innerHeight3)
  .lower();

const color3 = "#d18400";

const xScale3 = d3.scaleLinear().range([0, innerWidth3]);
const yScale3 = d3.scaleLinear().range([innerHeight3, 0]);

const lineGenerator3 = d3.line()
  .x(d => xScale3(d.year))
  .y(d => yScale3(d.mean))
  .curve(d3.curveMonotoneX);

const pointRadius3 = 4;

const tooltip3 = d3.select("#tooltip");

let data3 = [];

d3.csv("https://raw.githubusercontent.com/qLessqndr/road_traffic_ticino/refs/heads/main/total_year_means.csv").then(rawData => {
  data3 = rawData.map(d => ({
    year: +d.Year,
    mean: +d.Mean
  }));

  xScale3.domain(d3.extent(data3, d => d.year));
  yScale3.domain([0, d3.max(data3, d => d.mean)]);

  const xAxis3 = d3.axisBottom(xScale3).ticks(10).tickFormat(d3.format("d"));
  xAxisGroup3.call(xAxis3).selectAll("text")
    .style("fill", "white")
    .style("font-size", "14px")
    .style("font-family", "Helvetica");

  const yAxis3 = d3.axisLeft(yScale3);
  yAxisGroup3.call(yAxis3).selectAll("text")
    .style("fill", "white")
    .style("font-size", "14px")
    .style("font-family", "Helvetica");

  const path3 = g3.append("path")
    .datum(data3)
    .attr("class", "line")
    .attr("d", lineGenerator3)
    .attr("stroke", color3)
    .attr("opacity", 0);

  const points3 = g3.selectAll(".point")
    .data(data3)
    .enter().append("circle")
    .attr("class", "point")
    .attr("cx", d => xScale3(d.year))
    .attr("cy", d => yScale3(d.mean))
    .attr("r", 0)
    .attr("fill", color3)
    .on("mouseover", (event, d) => {
      d3.select(event.target)
        .transition()
        .duration(200)
        .attr("r", pointRadius3 * 2);

      tooltip3.style("visibility", "visible")
        .text(`Year: ${d.year}, Mean: ${d.mean.toFixed(0)}`)
        .style("top", `${event.pageY - 10}px`)
        .style("left", `${event.pageX + 10}px`);
    })
    .on("mouseout", (event) => {
      d3.select(event.target)
        .transition()
        .duration(200)
        .attr("r", pointRadius3);

      tooltip3.style("visibility", "hidden");
    });

  const animateLineAndPoints = () => {
    path3.transition()
      .duration(3000)
      .attr("opacity", 1);

    points3.transition()
      .delay((d, i) => i * 30)
      .duration(500)
      .attr("r", pointRadius3);
  };

  const hideLineAndPoints = () => {
    path3.transition().duration(500).attr("opacity", 0);
    points3.transition().duration(500).attr("r", 0);
  };

  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        animateLineAndPoints();
      } else {
        hideLineAndPoints();
      }
    });
  }, {
    threshold: 0.5
  });

  observer.observe(svg3.node());
});


// LINE 3

const svg4 = d3.select("#svg4");
const container3 = document.getElementById("svg-container4");
const width4 = container3.clientWidth;
const height4 = container3.clientHeight;

const margin4 = { top: 20, right: 200, bottom: 80, left: 100 };
const innerWidth4 = width4 - margin4.left - margin4.right;
const innerHeight4 = height4 - margin4.top - margin4.bottom;

const g4 = svg4.append("g").attr("transform", `translate(${margin4.left},${margin4.top})`);
const xAxisGroup4 = g4.append("g").attr("transform", `translate(0,${innerHeight4})`);
const yAxisGroup4 = g4.append("g");

const legendGroup = svg4.append("g")
  .attr("transform", `translate(${innerWidth4 + 50}, ${margin4.top})`)
  .attr("class", "legend-group")
  .style("visibility", "hidden");

g4.append("text")
  .attr("class", "x-axis-label")
  .attr("x", innerWidth4 / 2)
  .attr("y", innerHeight4 + 50)
  .attr("text-anchor", "middle")
  .style("fill", "white")
  .style("font-size", "16px")
  .style("font-family", "Helvetica")
  .text("Month");

g4.append("text")
  .attr("class", "y-axis-label")
  .attr("x", -innerHeight4 / 2)
  .attr("y", -75)
  .attr("transform", "rotate(-90)")
  .attr("text-anchor", "middle")
  .style("fill", "white")
  .style("font-size", "16px")
  .style("font-family", "Helvetica")
  .text("Daily Vehicle Count");

const colorScale4 = d3.scaleOrdinal(d3.schemeCategory10);

const xScale4 = d3.scalePoint().range([0, innerWidth4]);
const yScale4 = d3.scaleLinear().range([innerHeight4, 0]);

const lineGenerator4 = d3.line()
  .x(d => xScale4(d.month))
  .y(d => yScale4(d.value))
  .curve(d3.curveMonotoneX);

const tooltip4 = d3.select("#tooltip");

let data4 = [];
let aggregatedData = [];
let topStations = [];
let viewMode = "average";
const pointRadius4 = 4;
let activeStations = new Set();

d3.csv("https://raw.githubusercontent.com/qLessqndr/road_traffic_ticino/refs/heads/main/2023_ticino.csv").then(rawData => {
  const months = ["January", "February", "March", "April", "Mai", "June", "July", "August", "September", "October", "November", "December"];

  data4 = rawData.map(d => {
    return months.map(month => ({
      station: d["Measuring station"],
      month,
      value: +d[month]
    }));
  }).flat();

  aggregatedData = months.map(month => {
    const monthlyValues = data4.filter(d => d.month === month).map(d => d.value);
    return {
      month,
      value: d3.mean(monthlyValues)
    };
  });

  const stationAverages = d3.rollup(data4, 
    values => d3.mean(values, v => v.value), 
    d => d.station
  );

  topStations = Array.from(stationAverages.entries())
    .sort((a, b) => d3.descending(a[1], b[1]))
    .slice(0, 6)
    .map(d => d[0]);

  activeStations = new Set(topStations);

  xScale4.domain(months);

  const xAxis4 = d3.axisBottom(xScale4);
  xAxisGroup4.call(xAxis4).selectAll("text")
    .style("fill", "white")
    .style("font-size", "14px")
    .style("font-family", "Helvetica");

  const yAxis4 = d3.axisLeft(yScale4);

  const updateChart = () => {
    g4.selectAll(".line").remove();
    g4.selectAll(".point").remove();

    let dataToRender = viewMode === "average" 
      ? [aggregatedData] 
      : d3.groups(data4.filter(d => activeStations.has(d.station)), d => d.station).map(([station, values]) => values);

    const visibleStations = viewMode === "average" 
      ? aggregatedData 
      : dataToRender.flat();

    const yMax = d3.max(visibleStations, d => d.value);
    const yMin = d3.min(visibleStations, d => d.value);

    yScale4.domain([yMin, yMax]);

    yAxisGroup4.transition().duration(500).call(d3.axisLeft(yScale4).tickFormat(d3.format("~s")));
    g4.selectAll("text").style(
      "font-size", "14px",
    );

    g4.selectAll(".line")
      .data(dataToRender, d => (viewMode === "average" ? "average" : d[0].station))
      .enter()
      .append("path")
      .attr("class", "line")
      .attr("d", lineGenerator4)
      .attr("stroke", (d, i) => viewMode === "average" ? "#d18400" : colorScale4(d[0].station))
      .attr("fill", "none")
      .attr("stroke-width", 2)
      .attr("opacity", 0)
      .transition()
      .duration(3000)
      .attr("opacity", 1);

    g4.selectAll(".point-group")
      .data(dataToRender)
      .join(
        enter => enter.append("g").attr("class", "point-group")
      )
      .selectAll(".point")
      .data(d => d)
      .join(
        enter => enter.append("circle")
          .attr("class", "point")
          .attr("cx", d => xScale4(d.month))
          .attr("cy", d => yScale4(d.value))
          .attr("r", 0)
          .attr("fill", (d, i) => viewMode === "average" ? "#d18400" : colorScale4(d.station))
          .on("mouseover", (event, d) => {
            tooltip4.style("visibility", "visible")
              .text(viewMode === "average"
                ? `Month: ${d.month}, Mean: ${d.value.toFixed(0)}`
                : `Station: ${d.station}, Month: ${d.month}, Value: ${d.value}`)
          })
          .on("mouseout", () => tooltip4.style("visibility", "hidden"))
          .transition()
          .delay((d, i) => i * 30)
          .duration(500)
          .attr("r", pointRadius4)
      );

    legendGroup.style("visibility", viewMode === "average" ? "hidden" : "visible");
  };

  const updateLegend = () => {
    legendGroup.selectAll(".legend-item").remove();

    legendGroup.selectAll(".legend-item")
      .data(topStations)
      .enter()
      .append("g")
      .attr("class", "legend-item")
      .attr("transform", (d, i) => `translate(0, ${i * 25})`)
      .each(function(d) {
        const legendItem = d3.select(this);

        legendItem.append("rect")
          .attr("x", 0)
          .attr("y", -10)
          .attr("width", 20)
          .attr("height", 20)
          .attr("fill", () => activeStations.has(d) ? colorScale4(d) : "gray")
          .style("cursor", "pointer")
          .on("click", () => {
            if (activeStations.has(d)) {
              activeStations.delete(d);
            } else {
              activeStations.add(d);
            }
            updateChart();
            updateLegend();
          });

        legendItem.append("text")
          .attr("x", 30)
          .attr("y", 0)
          .attr("dy", "0.35em")
          .style("fill", "white")
          .style("font-size", "14px")
          .style("font-family", "Helvetica")
          .text(d);
      });
  };

  d3.select("#toggleButton").on("click", () => {
    viewMode = viewMode === "average" ? "stations" : "average";
    updateChart();
    updateLegend();
  });

  const animateOnViewport = (entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        updateChart();
        updateLegend();
      } else {
        g4.selectAll(".line, .point").remove();
      }
    });
  };

  const observer = new IntersectionObserver(animateOnViewport, { threshold: 0.5 });
  observer.observe(svg4.node());

  updateChart();
  updateLegend();
});



// MAPPA
const mapDiv = document.getElementById("map-container-2");
const sliderDiv = document.getElementById("slider-container-2");

const leafletMap = L.map(mapDiv).setView([46.2, 8.8], 10);

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
}).addTo(leafletMap);

const sliderElement = document.createElement("div");
sliderDiv.appendChild(sliderElement);

noUiSlider.create(sliderElement, {
    start: [0],
    range: {
        min: 0,
        max: 23.5
    },
    step: 0.5,
    pips: {
      mode: "range",
      start: 0,
      density: 3,
    },
    format: {
        to: (value) => {
            const hour = Math.floor(value);
            const minutes = value % 1 === 0 ? "00" : "30";
            
            return `${String(hour).padStart(2, '0')}:${minutes}`;
        },
        from: (value) => parseFloat(value.replace(":", ".")),
    },
});

let activePolylines = [];
let trafficData = [];
let timeLabels = [];
let lastActiveTimeIndex = 0;

async function fetchTrafficData(csvUrl) {
    const response = await fetch(csvUrl);
    if (!response.ok) throw new Error(`Failed to fetch ${csvUrl}`);
    const csvContent = await response.text();

    const [headerLine, ...dataLines] = csvContent.split("\n").filter(Boolean);
    const headers = headerLine.split(";").map(header => header.trim());

    timeLabels = headers.slice(2);

    return dataLines.map((line) => {
        const values = line.split(";");
        let cleanLocationData = values[0].trim();
        cleanLocationData = cleanLocationData.replace(/\(/g, '[').replace(/\)/g, ']');
        cleanLocationData = cleanLocationData.replace(/(\d),(\d)/g, '$1.$2');
        cleanLocationData = cleanLocationData.replace(/[\r\n]/g, '');
        let parsedCoordinates;
        try {
            parsedCoordinates = JSON.parse(cleanLocationData);
        } catch (error) {
            parsedCoordinates = [];
        }

        return {
            coordinates: parsedCoordinates,
            maxSpeed: +values[1],
            speeds: Object.fromEntries(
                timeLabels.map((label, index) => [label, +values[index + 2] || null])
            )
        };
    });
}

function renderTrafficDataOnMap(data, timeLabel) {
    if (!timeLabel) return;

    data.forEach(({ coordinates, maxSpeed, speeds }, i) => {
        if (coordinates && coordinates.length > 1) {
            const latLngCoordinates = coordinates.map(([lng, lat]) => [lat, lng]);
            const currentSpeed = speeds[timeLabel];

            if (currentSpeed === undefined || isNaN(currentSpeed)) {
                console.warn(`No valid speed data for timeLabel ${timeLabel} for segment ${i}`);
                return;
            }

            const speedRatio = currentSpeed / maxSpeed;
            let lineColor = "red";
            if (speedRatio > 0.8) {
                lineColor = "green";
            } else if (speedRatio > 0.5) {
                lineColor = "orange";
            }

            const polyline = L.polyline(latLngCoordinates, {
                color: lineColor,
                weight: 5,
                opacity: 0.7
            }).addTo(leafletMap);

            polyline.on('mouseover', (e) => {
                const hoverLocation = e.latlng || e.latlngs[0];
                const hoverContent = `Current speed: ${currentSpeed} km/h<br>Speed limit: ${maxSpeed} km/h`;
                e.target.bindTooltip(hoverContent).openTooltip(hoverLocation);
            });

            polyline.on('mouseout', (e) => {
                e.target.closeTooltip();
            });

            activePolylines[i] = polyline;
        }
    });
}


function formatDateForFileName(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${day}_${month}_${year}`;
}

async function initializeTrafficMap(selectedDate) {
    const date = new Date(selectedDate);
    const formattedDate = formatDateForFileName(date);
    const dataUrl = `https://raw.githubusercontent.com/qLessqndr/road_traffic_ticino/refs/heads/main/his_data/t_data_${formattedDate}.csv`;

    try {
        const csvData = await fetchTrafficData(dataUrl);
        trafficData = csvData;
        renderTrafficDataOnMap(trafficData, timeLabels[0]);

        const maxHour = parseInt(timeLabels[timeLabels.length-1].replace("_","").replace("30",""))+2;

        hours = Array.from({length:maxHour},(v,k)=>k)


        sliderElement.noUiSlider.updateOptions({
          pips: {
            values: hours,
            mode: "values",
            density: 3,
            max: [maxHour],
          },
            range: {
              min: 0,
              max: [maxHour-1],
            },
            start: 0,
            step: 1,
            format: {
                to: (index) => timeLabels[index] || "",
                from: (value) => timeLabels.indexOf(value)
            }
        });

        
        if (maxHour >= 23) {
          sliderElement.noUiSlider.updateOptions({
            pips: {      
              values: hours,
              mode: "values",
              density: 2,
              max: [maxHour-1],
            }
          })
        }

        if (timeLabels.length - 1 <= 8) {
          sliderElement.noUiSlider.updateOptions ({
            start: 0,
            pips : null,
            range: {
              'min': 0,
              'max': maxHour,
            }
          })
        }

        sliderElement.noUiSlider.on("slide", ([value]) => {
            const roundedValue = Math.round(value);
            const timeLabel = value;
            console.warn(timeLabel);
            if (timeLabel) {
                renderTrafficDataOnMap(trafficData, timeLabel);
            } else {
                console.warn(`Invalid slider value: ${value}`);
            }
        });
    } catch (error) {
        console.error("Error loading traffic data:", error);
    }
}

initializeTrafficMap(Date.now());


const datePickerButton = document.getElementById("date-picker-button");

const datePicker = document.getElementById("date-picker");

const today = new Date();
const minDate = new Date("2024-10-30");

datePicker.min = minDate.toISOString().split("T")[0];
datePicker.max = today.toISOString().split("T")[0];

datePicker.addEventListener("change", (event) => {
    const selectedDate = event.target.value;
    if (selectedDate) {
        initializeTrafficMap(selectedDate);
    }
});

function animateCounter(counter) {
  const target = +counter.getAttribute('data-target');
  const isFloat = target % 1 !== 0;
  const multiplier = isFloat ? 1000 : 1;
  const intTarget = target * multiplier;
  let count = intTarget * 0.8;
  const increment = intTarget / 250;

  const interval = setInterval(() => {
    count += increment;

    if (count >= intTarget) {
      count = intTarget;
      clearInterval(interval);
    }

    const text = counter.getAttribute('data-text');
    let displayValue = count / multiplier;

    if (isFloat) {
      displayValue =(Math.round(displayValue * 10) / 10).toFixed(1);
    } else {
      displayValue = Math.floor(displayValue);
    }

    counter.innerHTML = text.replace('v', `${displayValue}`);
  }, 20);
}

function isElementInViewport(el) {
  const rect = el.getBoundingClientRect();
  return rect.top < window.innerHeight && rect.bottom > 0;
}

function checkCounters() {
  const counters = document.querySelectorAll('.counter');
  counters.forEach(counter => {
    if (isElementInViewport(counter) && !counter.classList.contains('active')) {
      counter.classList.add('active');
      animateCounter(counter);
    } else if (!isElementInViewport(counter) && counter.classList.contains('active')) {
      counter.classList.remove('active');
      counter.innerHTML = counter.getAttribute('data-text');
    }
  });
}

window.addEventListener('scroll', checkCounters);
window.addEventListener('load', checkCounters);

window.addEventListener('focus', () => {
  const counters = document.querySelectorAll('.counter');
  counters.forEach(counter => {
    counter.classList.remove('active');
    counter.innerHTML = counter.getAttribute('data-text');
    animateCounter(counter);
  });
});



/*window.addEventListener('resize', () => {
      location.reload(); });*/

</script>